
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>A Tour of Symbolic PyMC &#8212; Symbolic PyMC  documentation</title>
    <link rel="stylesheet" href="_static/semantic-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/default.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/highlight.min.js"></script>
    <script type="text/javascript" src="_static/semantic.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="symbolic_pymc" href="modules.html" />
    <link rel="prev" title="Welcome to Symbolic PyMC’s documentation!" href="index.html" />
<script>hljs.initHighlightingOnLoad();</script>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">



  </head><body>
<div class="ui vertical center aligned">

    <div class="ui container">
        <div class="ui large secondary pointing menu">
            <a class="item" href="/">
                Symbolic
                <img class="ui bottom aligned tiny image" src="https://cdn.rawgit.com/pymc-devs/pymc3/master/docs/logos/svg/PyMC3_banner.svg" />
            </a>
             <a href="index.html" class="item">Index</a> <a href="symbolic-pymc-examples.html" class="item">Examples</a> <a href="modules.html" class="item">API</a>
            
            <div class="right menu">
                <div class="item">
                    <form class="ui icon input" action="search.html" method="get">
                        <input type="text" placeholder="Search..." name="q" />
                        <i class="search link icon"></i>
                    </form>
                </div>
                <a class="item" href="https://github.com/pymc-devs/symbolic-pymc"><i class="github blue icon large"></i></a>
            </div>
        </div>
    </div>
    
</div>

<div class="ui container" role="main">
    

    <div class="ui vertical segment">
        
  <div class="section" id="a-tour-of-symbolic-pymc">
<h1>A Tour of Symbolic PyMC<a class="headerlink" href="#a-tour-of-symbolic-pymc" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Brandon T. Willard</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>2019-08-03</p>
</dd>
</dl>
</div></blockquote>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this document we’ll cover the basics of the Symbolic PyMC package while
implementing a symbolic “search-and-replace” that changes TensorFlow graphs
like <code class="docutils literal notranslate"><span class="pre">tf.matmul(A,</span> <span class="pre">x</span> <span class="pre">+</span> <span class="pre">y)</span></code>into <code class="docutils literal notranslate"><span class="pre">tf.matmul(A,</span> <span class="pre">x)</span> <span class="pre">+</span> <span class="pre">tf.matmul(A,</span> <span class="pre">y)</span></code>.  In other words, we’ll
demonstrate how to implement the distributive property of matrix multiplication
so that it can be applied to arbitrary TensorFlow graphs.</p>
<p>Symbolic PyMC allows one to implement rewrite rules like the distributive
property–and many other sophisticated manipulations of graphs–by providing
flexible, pure Python versions of core operations in symbolic computation.
These operations are then combined and orchestrated through the relational
programming DSL <a class="reference external" href="http://minikanren.org/">miniKanren</a>.</p>
<p>More specifically, we’ll introduce the basic <strong>unification</strong> and <strong>reification</strong>
operations and explicitly show how they relate to graph manipulation and the
modeling of high-level mathematical relations.  Along the way, we’ll
cover some of the necessary details behind TensorFlow graphs and how they’re
modeled by <strong>meta graph objects</strong> in Symbolic PyMC.</p>
<p>We start by creating a graph of our target
expressions–i.e. <code class="docutils literal notranslate"><span class="pre">tf.matmul(A,</span> <span class="pre">x</span> <span class="pre">+</span> <span class="pre">y)</span></code>–in TensorFlow.
We need to do this in order to determine exactly what we’re searching for
and–later–what to put in its place.</p>
<div class="literal-block-wrapper docutils container" id="tf-matmul-graph">
<div class="code-block-caption"><span class="caption-number">Listing 1 </span><span class="caption-text">tf-matmul-graph</span><a class="headerlink" href="#tf-matmul-graph" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">IPython.lib.pretty</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">from</span> <span class="nn">tensorflow.python.eager.context</span> <span class="kn">import</span> <span class="n">graph_mode</span>


<span class="k">with</span> <span class="n">graph_mode</span><span class="p">():</span>
    <span class="c1"># Matrix</span>
    <span class="n">A_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]))</span>
    <span class="c1"># Column vectors</span>
    <span class="n">x_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">y_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># The multiplication</span>
    <span class="n">z_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A_tf</span><span class="p">,</span> <span class="n">x_tf</span> <span class="o">+</span> <span class="n">y_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>A text print-out of the full TensorFlow graph is provided by the debug print
function <code class="docutils literal notranslate"><span class="pre">tf_dprint</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="tf-print-graph">
<div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">tf-print-graph</span><a class="headerlink" href="#tf-print-graph" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">symbolic_pymc.tensorflow.printing</span> <span class="kn">import</span> <span class="n">tf_dprint</span>

<span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;add:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>The output of <a class="reference internal" href="#tf-print-graph"><span class="std std-numref">Listing 2</span></a> shows us the underlying operators (e.g. <code class="docutils literal notranslate"><span class="pre">MatMul</span></code>,
<code class="docutils literal notranslate"><span class="pre">Placeholder</span></code>, <code class="docutils literal notranslate"><span class="pre">AddV2</span></code>) and their arguments.</p>
<p>To “match/search for” combinations of TensorFlow operations–or, in other words, graphs–like
<a class="reference internal" href="#tf-print-graph"><span class="std std-numref">Listing 2</span></a>, we use <a class="reference external" href="https://en.wikipedia.org/wiki/Unification_(computer_science)">**unification**</a>; to “replace” parts of a graph (well, to produce copies with
replaced parts), we use <a class="reference external" href="https://en.wikipedia.org/wiki/Reification_(computer_science)">**reification**</a>.  Symbolic PyMC provides support for
these using <a class="reference external" href="https://www.tensorflow.org/">TensorFlow</a> (and <a class="reference external" href="http://deeplearning.net/software/theano/">Theano</a>) graphs via <strong>meta objects</strong> and <strong>expression-tuples</strong>.</p>
</div>
<div class="section" id="meta-objects">
<h2>Meta Objects<a class="headerlink" href="#meta-objects" title="Permalink to this headline">¶</a></h2>
<p>Meta objects model the essential components of TensorFlow graphs, while allowing one
to use input that isn’t normally valid.  More specifically, we can
construct meta graphs that contain <strong>logic variables</strong>.  Later, those logic
variables can be replaced with other objects that allow the meta graph to
be converted into a real TensorFlow graph.</p>
<p>Existing TensorFlow graphs can be converted to their meta graph equivalents with
the <code class="docutils literal notranslate"><span class="pre">mt</span></code> helper object.</p>
<div class="literal-block-wrapper docutils container" id="convert-to-meta">
<div class="code-block-caption"><span class="caption-number">Listing 3 </span><span class="caption-text">convert-to-meta</span><a class="headerlink" href="#convert-to-meta" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">symbolic_pymc.tensorflow.meta</span> <span class="kn">import</span> <span class="n">mt</span>


<span class="n">z_mt</span> <span class="o">=</span> <span class="n">mt</span><span class="p">(</span><span class="n">z_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="convert-to-meta-print">
<div class="code-block-caption"><span class="caption-number">Listing 4 </span><span class="caption-text">convert-to-meta-print</span><a class="headerlink" href="#convert-to-meta-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;add:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>A meta graph can be converted to a TensorFlow graph using its <code class="docutils literal notranslate"><span class="pre">reify</span></code> method.</p>
<div class="literal-block-wrapper docutils container" id="meta-to-tf">
<div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">meta-to-tf</span><a class="headerlink" href="#meta-to-tf" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_mt</span><span class="o">.</span><span class="n">reify</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;add:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mt</span></code> object also makes it easier to construct meta graphs by hand.</p>
<div class="literal-block-wrapper docutils container" id="create-meta-graph">
<div class="code-block-caption"><span class="caption-number">Listing 6 </span><span class="caption-text">create-meta-graph</span><a class="headerlink" href="#create-meta-graph" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unification</span> <span class="kn">import</span> <span class="n">unify</span><span class="p">,</span> <span class="n">reify</span><span class="p">,</span> <span class="n">var</span>


<span class="k">with</span> <span class="n">graph_mode</span><span class="p">():</span>
    <span class="n">add_mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">add_mt</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TFlowMetaTensor</span><span class="p">(</span>
  <span class="n">op</span><span class="o">=</span><span class="n">TFlowMetaOp</span><span class="p">(</span>
    <span class="n">op_def</span><span class="o">=</span><span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Add</span><span class="p">),</span>
    <span class="n">node_def</span><span class="o">=</span><span class="n">TFlowMetaNodeDef</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="o">~</span><span class="n">_6</span><span class="p">}),</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">TFlowMetaTensor</span><span class="p">(</span>
       <span class="n">op</span><span class="o">=</span><span class="n">TFlowMetaOp</span><span class="p">(</span>
         <span class="n">op_def</span><span class="o">=</span><span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Const</span><span class="p">),</span>
         <span class="n">node_def</span><span class="o">=</span><span class="n">TFlowMetaNodeDef</span><span class="p">(</span>
           <span class="n">op</span><span class="o">=</span><span class="s1">&#39;Const&#39;</span><span class="p">,</span>
           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Const&#39;</span><span class="p">,</span>
           <span class="n">attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">HashableNDArray</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">),</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">}),</span>
         <span class="n">inputs</span><span class="o">=</span><span class="p">()),</span>
       <span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
       <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
     <span class="o">~</span><span class="n">a</span><span class="p">)),</span>
  <span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
</div>
<p>In <a class="reference internal" href="#create-meta-graph"><span class="std std-numref">Listing 6</span></a>, we created a graph of <code class="docutils literal notranslate"><span class="pre">1</span></code> plus
a <code class="docutils literal notranslate"><span class="pre">unification</span></code> logic variable with the name <code class="docutils literal notranslate"><span class="pre">'a'</span></code>. This
wouldn’t be possible with a standard TensorFlow graph.</p>
<p>Also, because one of the elements in the graph is a logic variable, it cannot be
converted into a TensorFlow graph. Instead, if we attempt to use the meta
graph’s <code class="docutils literal notranslate"><span class="pre">reify</span></code> method, we are simply given the meta graph back.</p>
<div class="literal-block-wrapper docutils container" id="bad-reify-meta-graphh">
<div class="code-block-caption"><span class="caption-number">Listing 7 </span><span class="caption-text">bad-reify-meta-graphh</span><a class="headerlink" href="#bad-reify-meta-graphh" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">add_mt</span><span class="o">.</span><span class="n">reify</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TFlowMetaTensor</span><span class="p">(</span>
  <span class="n">op</span><span class="o">=</span><span class="n">TFlowMetaOp</span><span class="p">(</span>
    <span class="n">op_def</span><span class="o">=</span><span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Add</span><span class="p">),</span>
    <span class="n">node_def</span><span class="o">=</span><span class="n">TFlowMetaNodeDef</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="o">~</span><span class="n">_6</span><span class="p">}),</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">TFlowMetaTensor</span><span class="p">(</span>
       <span class="n">op</span><span class="o">=</span><span class="n">TFlowMetaOp</span><span class="p">(</span>
         <span class="n">op_def</span><span class="o">=</span><span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Const</span><span class="p">),</span>
         <span class="n">node_def</span><span class="o">=</span><span class="n">TFlowMetaNodeDef</span><span class="p">(</span>
           <span class="n">op</span><span class="o">=</span><span class="s1">&#39;Const&#39;</span><span class="p">,</span>
           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Const&#39;</span><span class="p">,</span>
           <span class="n">attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">HashableNDArray</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">),</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">}),</span>
         <span class="n">inputs</span><span class="o">=</span><span class="p">()),</span>
       <span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
       <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
     <span class="o">~</span><span class="n">a</span><span class="p">)),</span>
  <span class="n">value_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-expressions">
<h2>S-expressions<a class="headerlink" href="#s-expressions" title="Permalink to this headline">¶</a></h2>
<p>As an alternative approach to full meta graph conversion, we can also convert
TensorFlow graphs into an <a class="reference external" href="https://en.wikipedia.org/wiki/S-expression">S-expression-like</a> form.</p>
<div class="literal-block-wrapper docutils container" id="etuplize-graph">
<div class="code-block-caption"><span class="caption-number">Listing 8 </span><span class="caption-text">etuplize-graph</span><a class="headerlink" href="#etuplize-graph" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">symbolic_pymc.etuple</span> <span class="kn">import</span> <span class="n">etuple</span><span class="p">,</span> <span class="n">etuplize</span>


<span class="n">z_sexp</span> <span class="o">=</span> <span class="n">etuplize</span><span class="p">(</span><span class="n">z_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="etuplize-graph-print">
<div class="code-block-caption"><span class="caption-number">Listing 9 </span><span class="caption-text">etuplize-graph-print</span><a class="headerlink" href="#etuplize-graph-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">z_sexp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="p">(</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
    <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">MatMul</span><span class="p">),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
      <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
      <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
      <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose_a&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;transpose_b&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})),</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
      <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
        <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
        <span class="s1">&#39;A&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
         <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))}))),</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
      <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">AddV2</span><span class="p">),</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
        <span class="s1">&#39;AddV2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;add&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">})),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
        <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
        <span class="n">e</span><span class="p">(</span>
          <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
          <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
          <span class="s1">&#39;x&#39;</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
           <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}))),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
        <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
        <span class="n">e</span><span class="p">(</span>
          <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
          <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
          <span class="s1">&#39;y&#39;</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
           <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">})))))</span>
</pre></div>
</div>
<p>An <code class="docutils literal notranslate"><span class="pre">etuple</span></code> is like a
normal <code class="docutils literal notranslate"><span class="pre">tuple</span></code>, except that its first element is
a <code class="docutils literal notranslate"><span class="pre">Callable</span></code> and the remaining elements are
the <code class="docutils literal notranslate"><span class="pre">Callable</span></code>’s arguments.
As above, a pretty-printed <code class="docutils literal notranslate"><span class="pre">etuple</span></code> looks like
a <code class="docutils literal notranslate"><span class="pre">tuple</span></code> prefixed by an <code class="docutils literal notranslate"><span class="pre">e</span></code>.</p>
<p>By working with <code class="docutils literal notranslate"><span class="pre">etuple</span></code>s, we can use <strong>arbitrary Python functions</strong> in
conjunction with meta graphs and logic variable arguments.  Basically,
an <code class="docutils literal notranslate"><span class="pre">etuple</span></code> can be manipulated until all of its constituent logic
variables and meta objects are eventually replaced with valid arguments to the
function/operator.  At that point, the <code class="docutils literal notranslate"><span class="pre">etuple</span></code> can be evaluated.</p>
<p>For example, in <a class="reference internal" href="#etuple-eval-example"><span class="std std-numref">Listing 10</span></a>, we create an <code class="docutils literal notranslate"><span class="pre">etuple</span></code>that uses the TensorFlow function <code class="docutils literal notranslate"><span class="pre">tf.add</span></code> with a logic variable argument.</p>
<div class="literal-block-wrapper docutils container" id="etuple-eval-example">
<div class="code-block-caption"><span class="caption-number">Listing 10 </span><span class="caption-text">etuple-eval-example</span><a class="headerlink" href="#etuple-eval-example" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x_lv</span><span class="p">,</span> <span class="n">y_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">add_tf_pat</span> <span class="o">=</span> <span class="n">etuple</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">x_lv</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Normally, it wouldn’t be possible to call this function with these argument
types, as demonstrated in <a class="reference internal" href="#etuple-bad-usage-example"><span class="std std-numref">Listing 11</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="etuple-bad-usage-example">
<div class="code-block-caption"><span class="caption-number">Listing 11 </span><span class="caption-text">etuple-bad-usage-example</span><a class="headerlink" href="#etuple-bad-usage-example" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>2019-11-17 20:48:04.437195: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
2019-11-17 20:48:04.461487: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2112000000 Hz
2019-11-17 20:48:04.462162: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x558d5e551fc0 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2019-11-17 20:48:04.462183: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version
Attempt to convert a value (~x) with an unsupported type (&lt;class &#39;unification.variable.Var&#39;&gt;) to a Tensor.
</pre></div>
</div>
<p>We’ll get the same error if we attempt to evaluate
the <code class="docutils literal notranslate"><span class="pre">etuple</span></code> by accessing
its <code class="docutils literal notranslate"><span class="pre">ExpressionTuple.eval_obj</span></code> property.  However, after
performing a simple manipulation that replaces the logic variable with valid
inputs to <code class="docutils literal notranslate"><span class="pre">tf.add</span></code>, we are able to evaluate
the <code class="docutils literal notranslate"><span class="pre">etuple</span></code> and obtain a TF Tensor result, as
demonstrated in <a class="reference internal" href="#etuple-reify-example"><span class="std std-numref">Listing 12</span></a> and
<a class="reference internal" href="#etuple-reify-eval-print-example"><span class="std std-numref">Listing 14</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="etuple-reify-example">
<div class="code-block-caption"><span class="caption-number">Listing 12 </span><span class="caption-text">etuple-reify-example</span><a class="headerlink" href="#etuple-reify-example" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">add_pat_new</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="n">add_tf_pat</span><span class="p">,</span> <span class="p">{</span><span class="n">x_lv</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="etuple-reify-print-example">
<div class="code-block-caption"><span class="caption-number">Listing 13 </span><span class="caption-text">etuple-reify-print-example</span><a class="headerlink" href="#etuple-reify-print-example" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">add_pat_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">gen_math_ops</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="etuple-reify-eval-print-example">
<div class="code-block-caption"><span class="caption-number">Listing 14 </span><span class="caption-text">etuple-reify-eval-print-example</span><a class="headerlink" href="#etuple-reify-eval-print-example" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">add_pat_new</span><span class="o">.</span><span class="n">eval_obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">,</span> <span class="n">numpy</span><span class="o">=</span><span class="mi">2</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Working with S-expressions is much like manipulating a subset of Python AST, so,
when using <code class="docutils literal notranslate"><span class="pre">etuple</span></code>s, one is–in effect–<strong>meta programming</strong> (e.g. by automating the production and evaluation of
TensorFlow-using Python code).</p>
<p>As a matter of fact, <code class="docutils literal notranslate"><span class="pre">etuple</span></code>s could be recast
as <code class="docutils literal notranslate"><span class="pre">ast.Expr</span></code> and <code class="docutils literal notranslate"><span class="pre">ast.Call</span></code>objects that, through the use of <code class="docutils literal notranslate"><span class="pre">eval</span></code>, could achieve
the same results–albeit without the more convenient tuple-like structuring.</p>
</div>
<div class="section" id="meta-operators-and-their-parameters">
<h2>Meta Operators and their Parameters<a class="headerlink" href="#meta-operators-and-their-parameters" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference internal" href="#etuplize-graph-print"><span class="std std-numref">Listing 9</span></a>, the <code class="docutils literal notranslate"><span class="pre">etuple</span></code> form of
our matrix multiplication graph, <code class="docutils literal notranslate"><span class="pre">z_sexp</span></code>, produced
<code class="docutils literal notranslate"><span class="pre">symbolic_pymc.tensorflow.meta.TFlowMetaOperator</span></code>in the function/operator position.  <a class="reference internal" href="#print-etuple-operator"><span class="std std-numref">Listing 15</span></a> prints
only the function part of the <code class="docutils literal notranslate"><span class="pre">etuple</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="print-etuple-operator">
<div class="code-block-caption"><span class="caption-number">Listing 15 </span><span class="caption-text">print-etuple-operator</span><a class="headerlink" href="#print-etuple-operator" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">z_sexp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="p">(</span>
  <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
  <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">MatMul</span><span class="p">),</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
    <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
    <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose_a&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;transpose_b&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}))</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">TFlowMetaOperator</span></code> is an abstraction that combines the
TF <code class="docutils literal notranslate"><span class="pre">OpDef</span></code> and <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code> that,
when paired with operator arguments, comprises a valid
TF <code class="docutils literal notranslate"><span class="pre">Operation</span></code>.</p>
<p>When we call <code class="docutils literal notranslate"><span class="pre">mt.add</span></code> we’re imitating the TF user-level API function
<code class="docutils literal notranslate"><span class="pre">tf.add</span></code>.  Behind the scenes, <code class="docutils literal notranslate"><span class="pre">tf.add</span></code> obtains
the <code class="docutils literal notranslate"><span class="pre">OpDef</span></code>, creates the <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code> and
produces an <code class="docutils literal notranslate"><span class="pre">Operation</span></code>.  Since we can’t directly use helper functions like
<code class="docutils literal notranslate"><span class="pre">tf.add</span></code> with our logic variables, the meta objects have to recreate
the same process and that’s what <code class="docutils literal notranslate"><span class="pre">TFlowMetaOperator</span></code> does.</p>
<p>More importantly, it does so in a way that allows for some intercession so that logic variables
can be used.  For instance, TF <code class="docutils literal notranslate"><span class="pre">Operation</span></code>s are necessarily assigned unique
names, so, if we wanted to match graphs produced by <code class="docutils literal notranslate"><span class="pre">tf.add</span></code>, we would
either need to know the explicit names of its <code class="docutils literal notranslate"><span class="pre">Operation</span></code>s,
or use logic variables in their place.  The <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code> holds the
name value, so we could set that property–or the
entire <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code>–to a logic variable and match <strong>any</strong> .</p>
<p>The same goes for extra options associated with an
<code class="docutils literal notranslate"><span class="pre">Operation</span></code>’s <code class="docutils literal notranslate"><span class="pre">OpDef</span></code>.  Notice that the
<code class="docutils literal notranslate"><span class="pre">NodeDef</span></code> in the meta operator for <code class="docutils literal notranslate"><span class="pre">tf.matmul</span></code>has a <code class="docutils literal notranslate"><span class="pre">dict</span></code> containing <code class="docutils literal notranslate"><span class="pre">transpose_*</span></code> entries.
These are the default values for the TF function <code class="docutils literal notranslate"><span class="pre">tf.matmul</span></code> (see
<a class="reference internal" href="#print-tf-matmul"><span class="std std-numref">Listing 16</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="print-tf-matmul">
<div class="code-block-caption"><span class="caption-number">Listing 16 </span><span class="caption-text">print-tf-matmul</span><a class="headerlink" href="#print-tf-matmul" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">function</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">math_ops</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">adjoint_a</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">adjoint_b</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">a_is_sparse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">b_is_sparse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Meta operators make it easier to set an entire <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code>to a logic variable so that one can find graphs based only on the high-level
operations they perform (e.g. multiplication).  Furthermore, it separates the
high-level operator’s <strong>arguments</strong> from its <strong>parameters</strong>.  Take the matrix
multiplication above; at the mathematical level, matrix multiplication only
takes the objects it’s multiplying as arguments, and not any “transpose”
parameters.</p>
<p>When we want to make general statements about the properties of a mathematical
operator, this confusion of arguments and parameters only requires more work to
separate them.  Let’s say we wanted to programmatically state that addition is
commutative, so that our matching process could consider any order of arguments.
If we followed TensorFlow’s convention, we would–at minimum–need to include
special logic to determine which arguments are applicable.</p>
<p>We’ll see examples of <code class="docutils literal notranslate"><span class="pre">TFlowMetaOperator</span></code>’s use in the
sections that follow.</p>
</div>
<div class="section" id="unification-and-reification">
<h2>Unification and Reification<a class="headerlink" href="#unification-and-reification" title="Permalink to this headline">¶</a></h2>
<p>With the ability to use logic variables and TensorFlow graphs together, we can
now “search” or “match” arbitrary graphs using <strong>unification</strong> and produce new
graphs by replacing logic variables using <strong>reification</strong>.</p>
<p>We start by making “patterns” or templates for the subgraphs we would like to match.
Patterns, in this case, take the form of meta graphs or S-expr graphs with the
desired structure and logic variables in place of “unknown” or arbitrary terms
that we might like to reference elsewhere.</p>
<p><a class="reference internal" href="#matmul-pattern"><span class="std std-numref">Listing 17</span></a> represents an S-expr that evaluates to a graph in
which two terms are matrix-multiplied.</p>
<div class="literal-block-wrapper docutils container" id="matmul-pattern">
<div class="code-block-caption"><span class="caption-number">Listing 17 </span><span class="caption-text">matmul-pattern</span><a class="headerlink" href="#matmul-pattern" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">symbolic_pymc.tensorflow.meta</span> <span class="kn">import</span> <span class="n">TFlowMetaOperator</span>


<span class="n">A_lv</span><span class="p">,</span> <span class="n">B_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="n">node_def_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;node_def&#39;</span><span class="p">)</span>

<span class="n">matmul_op_mt</span> <span class="o">=</span> <span class="n">TFlowMetaOperator</span><span class="p">(</span><span class="s1">&#39;matmul&#39;</span><span class="p">,</span> <span class="n">node_def_lv</span><span class="p">)</span>
<span class="n">matmul_pat_mt</span> <span class="o">=</span> <span class="n">matmul_op_mt</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">B_lv</span><span class="p">)</span>

<span class="n">matmul_pat</span> <span class="o">=</span> <span class="n">etuplize</span><span class="p">(</span><span class="n">matmul_pat_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In <a class="reference internal" href="#matmul-pattern"><span class="std std-numref">Listing 17</span></a> we created a meta
graph, <code class="docutils literal notranslate"><span class="pre">matmul_pat_mt</span></code>, from a meta
TF <code class="docutils literal notranslate"><span class="pre">MatMul</span></code> operator and a
variable <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code>, then we applied that meta operator to
two logic variable arguments.</p>
<p>The logic variable <code class="docutils literal notranslate"><span class="pre">node_def_lv</span></code> is there to match the parameters
to <code class="docutils literal notranslate"><span class="pre">tf.matmul</span></code>:
e.g.
<code class="docutils literal notranslate"><span class="pre">transpose_a</span></code>, <code class="docutils literal notranslate"><span class="pre">transpose_b</span></code>, and
the name parameter.
Again, by setting the <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code> in our meta operator to a
to logic variable, we are allowing unification with <strong>any</strong> matrix multiplication
(e.g. not just ones named <code class="docutils literal notranslate"><span class="pre">&quot;blah&quot;</span></code>, or ones with
transposed second arguments).</p>
<p>“Matching” a graph against our pattern is actually called <strong>unification</strong>.
Unification of two graphs implies unification of all sub-graphs and elements
between them.  When unification is successful, it returns a map of logic
variables and their unified values.  If there are no logic variables in the
graphs–it simply returns an empty map.  If unification fails, it
returns <code class="docutils literal notranslate"><span class="pre">False</span></code>–at least in the implementation we use, but not
necessarily in general.</p>
<div class="section" id="id1">
<h3>Unification<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>We can perform the unification using the function <code class="docutils literal notranslate"><span class="pre">unify</span></code>.  The result
is a <code class="docutils literal notranslate"><span class="pre">dict</span></code> mapping logic variables to their unified values.</p>
<div class="literal-block-wrapper docutils container" id="matmul-pattern-unify">
<div class="code-block-caption"><span class="caption-number">Listing 18 </span><span class="caption-text">matmul-pattern-unify</span><a class="headerlink" href="#matmul-pattern-unify" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">matmul_pat</span><span class="p">,</span> <span class="n">z_sexp</span><span class="p">,</span> <span class="p">{})</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="matmul-pattern-unify-print">
<div class="code-block-caption"><span class="caption-number">Listing 19 </span><span class="caption-text">matmul-pattern-unify-print</span><a class="headerlink" href="#matmul-pattern-unify-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">~</span><span class="n">node_def</span><span class="p">:</span> <span class="n">e</span><span class="p">(</span>
   <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
   <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
   <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
   <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose_a&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;transpose_b&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
 <span class="o">~</span><span class="n">A</span><span class="p">:</span> <span class="n">e</span><span class="p">(</span>
   <span class="n">e</span><span class="p">(</span>
     <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
     <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
     <span class="n">e</span><span class="p">(</span>
       <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
       <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
       <span class="s1">&#39;A&#39;</span><span class="p">,</span>
       <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))}))),</span>
 <span class="o">~</span><span class="n">B</span><span class="p">:</span> <span class="n">e</span><span class="p">(</span>
   <span class="n">e</span><span class="p">(</span>
     <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
     <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">AddV2</span><span class="p">),</span>
     <span class="n">e</span><span class="p">(</span>
       <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
       <span class="s1">&#39;AddV2&#39;</span><span class="p">,</span>
       <span class="s1">&#39;add&#39;</span><span class="p">,</span>
       <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">})),</span>
   <span class="n">e</span><span class="p">(</span>
     <span class="n">e</span><span class="p">(</span>
       <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
       <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
       <span class="n">e</span><span class="p">(</span>
         <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
         <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
         <span class="s1">&#39;x&#39;</span><span class="p">,</span>
         <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
          <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}))),</span>
   <span class="n">e</span><span class="p">(</span>
     <span class="n">e</span><span class="p">(</span>
       <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
       <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
       <span class="n">e</span><span class="p">(</span>
         <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
         <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
         <span class="s1">&#39;y&#39;</span><span class="p">,</span>
         <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
          <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">}))))}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Reification<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Using <code class="docutils literal notranslate"><span class="pre">reify</span></code>, we can “fill-in”–or replace–the logic variables of
our “pattern” with the matches obtained by <code class="docutils literal notranslate"><span class="pre">unify</span></code> that are held
within the variable <code class="docutils literal notranslate"><span class="pre">s</span></code>, or we could specify our own substitutions
based on that information.</p>
<p>In <a class="reference internal" href="#matmul-pattern-reify"><span class="std std-numref">Listing 20</span></a>, we simply change the <code class="docutils literal notranslate"><span class="pre">'name'</span></code> value in the
and create a new graph with that value.  The end result is a version of the original
graph, <code class="docutils literal notranslate"><span class="pre">z_sexp</span></code>, with a new name.</p>
<div class="literal-block-wrapper docutils container" id="matmul-pattern-reify">
<div class="code-block-caption"><span class="caption-number">Listing 20 </span><span class="caption-text">matmul-pattern-reify</span><a class="headerlink" href="#matmul-pattern-reify" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;node_def&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;node_def&#39;</span><span class="p">)][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;a_new_name&quot;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="s1">&#39;node_def&#39;</span><span class="p">)][</span><span class="mi">3</span><span class="p">:]</span>

<span class="n">z_sexp_re</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="n">matmul_pat</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="matmul-pattern-reify-print">
<div class="code-block-caption"><span class="caption-number">Listing 21 </span><span class="caption-text">matmul-pattern-reify-print</span><a class="headerlink" href="#matmul-pattern-reify-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">z_sexp_re</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="p">(</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
    <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">MatMul</span><span class="p">),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
      <span class="s1">&#39;MatMul&#39;</span><span class="p">,</span>
      <span class="s1">&#39;a_new_name&#39;</span><span class="p">,</span>
      <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose_a&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;transpose_b&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})),</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
      <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
        <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
        <span class="s1">&#39;A&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
         <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))}))),</span>
  <span class="n">e</span><span class="p">(</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
      <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">AddV2</span><span class="p">),</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
        <span class="s1">&#39;AddV2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;add&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">})),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
        <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
        <span class="n">e</span><span class="p">(</span>
          <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
          <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
          <span class="s1">&#39;x&#39;</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
           <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}))),</span>
    <span class="n">e</span><span class="p">(</span>
      <span class="n">e</span><span class="p">(</span>
        <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaOperator</span><span class="p">,</span>
        <span class="n">TFlowMetaOpDef</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">),</span>
        <span class="n">e</span><span class="p">(</span>
          <span class="n">symbolic_pymc</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">TFlowMetaNodeDef</span><span class="p">,</span>
          <span class="s1">&#39;Placeholder&#39;</span><span class="p">,</span>
          <span class="s1">&#39;y&#39;</span><span class="p">,</span>
          <span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">TFlowMetaTensorShape</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
           <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">})))))</span>
</pre></div>
</div>
</div>
<div class="section" id="finishing-our-implementation">
<h3>Finishing our Implementation<a class="headerlink" href="#finishing-our-implementation" title="Permalink to this headline">¶</a></h3>
<p>We can also reify an entirely different graph using the values extracted from
the graph <code class="docutils literal notranslate"><span class="pre">z_sexp</span></code>.  In this case, we create an “output”
pattern graph, to complement our “input” pattern
graph, <code class="docutils literal notranslate"><span class="pre">matmul_pat</span></code>.</p>
<p>If we combine our matrix multiplication and
addition <code class="docutils literal notranslate"><span class="pre">etuple</span></code> patterns, we can extract all the
arguments needed as input to a distributed multiplication pattern.</p>
<div class="literal-block-wrapper docutils container" id="dist-new-pattern">
<div class="code-block-caption"><span class="caption-number">Listing 22 </span><span class="caption-text">dist-new-pattern</span><a class="headerlink" href="#dist-new-pattern" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">add_op_mt</span> <span class="o">=</span> <span class="n">TFlowMetaOperator</span><span class="p">(</span><span class="s1">&#39;addv2&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;add_node_def&#39;</span><span class="p">))</span>

<span class="n">output_pat_mt</span> <span class="o">=</span> <span class="n">add_op_mt</span><span class="p">(</span><span class="n">matmul_op_mt</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">x_lv</span><span class="p">),</span> <span class="n">matmul_op_mt</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">))</span>

<span class="n">output_pat</span> <span class="o">=</span> <span class="n">etuplize</span><span class="p">(</span><span class="n">output_pat_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>With logic
variables <code class="docutils literal notranslate"><span class="pre">A_lv</span></code>, <code class="docutils literal notranslate"><span class="pre">x_lv</span></code>and <code class="docutils literal notranslate"><span class="pre">y_lv</span></code> mapped to their template-corresponding objects
in another graph, we can reify <code class="docutils literal notranslate"><span class="pre">output_pat</span></code> and obtain a
“transformed” version of said graph.</p>
<p>Using our earlier unification results in <a class="reference internal" href="#matmul-pattern-unify"><span class="std std-numref">Listing 18</span></a>, we only
need to reify our output pattern, <code class="docutils literal notranslate"><span class="pre">output_pat</span></code>, with
those mappings.  However, since our output pattern refers to logic variables
<code class="docutils literal notranslate"><span class="pre">x_lv</span></code> and <code class="docutils literal notranslate"><span class="pre">y_lv</span></code>, we’ll need
to unify those logic variables with the appropriate terms in the graph.</p>
<p><a class="reference internal" href="#dist-add-unify"><span class="std std-numref">Listing 23</span></a>, unifies the remaining terms by simply extracting the
<code class="docutils literal notranslate"><span class="pre">B</span></code> argument in the matrix multiply and unifying
that with a pattern for tensor addition.</p>
<div class="literal-block-wrapper docutils container" id="dist-add-unify">
<div class="code-block-caption"><span class="caption-number">Listing 23 </span><span class="caption-text">dist-add-unify</span><a class="headerlink" href="#dist-add-unify" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">add_pat</span> <span class="o">=</span> <span class="n">etuple</span><span class="p">(</span><span class="n">etuplize</span><span class="p">(</span><span class="n">add_op_mt</span><span class="p">),</span> <span class="n">x_lv</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">)</span>

<span class="n">s_add</span> <span class="o">=</span> <span class="n">unify</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">B_lv</span><span class="p">],</span> <span class="n">add_pat</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="dist-new-pattern-reify">
<div class="code-block-caption"><span class="caption-number">Listing 24 </span><span class="caption-text">dist-new-pattern-reify</span><a class="headerlink" href="#dist-new-pattern-reify" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">z_new</span> <span class="o">=</span> <span class="n">reify</span><span class="p">(</span><span class="n">output_pat</span><span class="p">,</span> <span class="n">s_add</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="dist-new-pattern-reify-print">
<div class="code-block-caption"><span class="caption-number">Listing 25 </span><span class="caption-text">dist-new-pattern-reify-print</span><a class="headerlink" href="#dist-new-pattern-reify-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_new</span><span class="o">.</span><span class="n">eval_obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_11</span><span class="p">,</span>     <span class="s2">&quot;add:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_12</span><span class="p">,</span>     <span class="s2">&quot;a_new_name:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_13</span><span class="p">,</span>     <span class="s2">&quot;a_new_name:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>As we’ve seen, using only the basics of unification and reification provided by
Symbolic PyMC, one can extract specific elements from TensorFlow graphs and use
them to implement mathematical identities/relations.  Through clever use of
multiple mathematical relations, one can–for example–construct graph
<strong>optimizations</strong> that turn large classes of user-defined statistical models into
computational tractable reformulations.  Similarly, one can construct “normal forms”
for models, making it possible to determine whether or not a user-defined model
is suitable for a specific sampler.</p>
<p>Next, we’ll introduce another major element of Symbolic PyMC that orchestrates
and simplifies sequences of unifications like we used earlier, provides
control-flow-like capabilities, produces fully reified results of arbitrary
form, and does so within a genuinely declarative formalism that carries much of
the same power as logic programming: <a class="reference external" href="http://minikanren.org/">miniKanren</a>!</p>
</div>
</div>
<div class="section" id="relational-programming-in-minikanren">
<h2>Relational Programming in miniKanren<a class="headerlink" href="#relational-programming-in-minikanren" title="Permalink to this headline">¶</a></h2>
<p>As mentioned at the end of the last section, Symbolic PyMC uses a Python
implementation of the embedded domain-specific language miniKanren–provided by
the <code class="docutils literal notranslate"><span class="pre">kanren</span></code> package–to orchestrate more sophisticated uses of
unification and reification.  For a quick intro, see <a class="reference external" href="https://github.com/logpy/logpy/blob/master/doc/basic.md">the basic introduction</a>
provided by the <code class="docutils literal notranslate"><span class="pre">kanren</span></code> package.  We’ll cover most of the same
basic material here, but not all.</p>
<p>To start, miniKanren uses <strong>goals</strong> (in the same sense as <a class="reference external" href="https://en.wikipedia.org/wiki/Logic_programming">logic programming</a>) to
assert relations, and the <code class="docutils literal notranslate"><span class="pre">run</span></code> function evaluates those goals and
allows one to specify the exact amount and type of reified output desired from
the <strong>states</strong> that satisfy the goals.</p>
<p>In their most basic form, miniKanren <strong>states</strong> are simply the substitution maps returned by
unification, which–in the normal course of operation–aren’t dealt with directly.</p>
<div class="section" id="the-basic-goals">
<h3>The Basic Goals<a class="headerlink" href="#the-basic-goals" title="Permalink to this headline">¶</a></h3>
<p>Normally, a user will only need to construct compound goals from a basic set of
primitives.  Arguably, the most primitive goal is the <a class="reference external" href="https://en.wikipedia.org/wiki/Equivalence_relation">equivalence relation</a>
under unification denoted by <code class="docutils literal notranslate"><span class="pre">eq</span></code> in Python.</p>
<p>In <a class="reference internal" href="#mk-basics-eq"><span class="std std-numref">Listing 26</span></a>, we ask for all successful results/reifications (signified
by the <code class="docutils literal notranslate"><span class="pre">0</span></code> argument) of the logic variable <code class="docutils literal notranslate"><span class="pre">var('q')</span></code> for the goal
<code class="docutils literal notranslate"><span class="pre">eq(var('q'),</span> <span class="pre">1)</span></code>–i.e. unify <code class="docutils literal notranslate"><span class="pre">var('q')</span></code> with <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="mk-basics-eq">
<div class="code-block-caption"><span class="caption-number">Listing 26 </span><span class="caption-text">mk-basics-eq</span><a class="headerlink" href="#mk-basics-eq" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kanren</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">eq</span>

<span class="n">q_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-basics-eq-print">
<div class="code-block-caption"><span class="caption-number">Listing 27 </span><span class="caption-text">mk-basics-eq-print</span><a class="headerlink" href="#mk-basics-eq-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
<p>Since miniKanren’s <code class="docutils literal notranslate"><span class="pre">run</span></code> always returns a stream of results, we obtain
a tuple containing the reified value of <code class="docutils literal notranslate"><span class="pre">q_lv</span></code> under the one
possible state for which our stated goal successfully evaluates.</p>
<p>The other basic primitives represent conjunction and disjunction of miniKanren
goals: <code class="docutils literal notranslate"><span class="pre">lall</span></code> and <code class="docutils literal notranslate"><span class="pre">lany</span></code>, respectively.</p>
<div class="literal-block-wrapper docutils container" id="mk-basics-lall">
<div class="code-block-caption"><span class="caption-number">Listing 28 </span><span class="caption-text">mk-basics-lall</span><a class="headerlink" href="#mk-basics-lall" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kanren</span> <span class="kn">import</span> <span class="n">lall</span><span class="p">,</span> <span class="n">lany</span>

<span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">lall</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-basics-lall-print">
<div class="code-block-caption"><span class="caption-number">Listing 29 </span><span class="caption-text">mk-basics-lall-print</span><a class="headerlink" href="#mk-basics-lall-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">()</span>
</pre></div>
</div>
<p>In <a class="reference internal" href="#mk-basics-lall"><span class="std std-numref">Listing 28</span></a>, we used <code class="docutils literal notranslate"><span class="pre">lall</span></code> to obtain the conjunction of two unification goals.
Since we requested that the same logic variable be unified
with both <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code> simultaneously (i.e. in the same
state), which isn’t possible, we got back an empty stream of results–indicating failure.</p>
<p>Goal disjunction, <code class="docutils literal notranslate"><span class="pre">lany</span></code>, will split a state stream across goals,
producing new distinct states for each.</p>
<div class="literal-block-wrapper docutils container" id="mk-basics-lany">
<div class="code-block-caption"><span class="caption-number">Listing 30 </span><span class="caption-text">mk-basics-lany</span><a class="headerlink" href="#mk-basics-lany" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">lany</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-basics-lany-print">
<div class="code-block-caption"><span class="caption-number">Listing 31 </span><span class="caption-text">mk-basics-lany-print</span><a class="headerlink" href="#mk-basics-lany-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The goal disjunction results in <a class="reference internal" href="#mk-basics-lany-print"><span class="std std-numref">Listing 31</span></a> show that the logic variable
<code class="docutils literal notranslate"><span class="pre">q_lv</span></code> can be unified with either <code class="docutils literal notranslate"><span class="pre">1</span></code> <strong>or</strong> <code class="docutils literal notranslate"><span class="pre">2</span></code> under the
two unification goals.</p>
<p>A common pattern of disjunction and conjunction is called <code class="docutils literal notranslate"><span class="pre">conde</span></code>, and
it mirrors the Lisp function <code class="docutils literal notranslate"><span class="pre">cond</span></code>, which is effectively a type of
compound <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">...</span> <span class="pre">elif</span> <span class="pre">...</span> <span class="pre">elif</span> <span class="pre">...</span></code>.  Specifically,
<code class="docutils literal notranslate"><span class="pre">conde([x_1,</span> <span class="pre">...],</span> <span class="pre">...,</span> <span class="pre">[y_1,</span> <span class="pre">...])</span></code> is the same as
<code class="docutils literal notranslate"><span class="pre">lany(lall(x_1,</span> <span class="pre">...),</span> <span class="pre">...,</span> <span class="pre">lall(y_1,</span> <span class="pre">...))</span></code>–i.e. a disjunction of goal conjunctions.</p>
<div class="literal-block-wrapper docutils container" id="mk-basics-conde">
<div class="code-block-caption"><span class="caption-number">Listing 32 </span><span class="caption-text">mk-basics-conde</span><a class="headerlink" href="#mk-basics-conde" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kanren</span> <span class="kn">import</span> <span class="n">conde</span>

<span class="n">r_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">q_lv</span><span class="p">,</span> <span class="n">r_lv</span><span class="p">],</span>
             <span class="n">conde</span><span class="p">(</span>
                 <span class="p">[</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">r_lv</span><span class="p">,</span> <span class="mi">10</span><span class="p">)],</span>
                 <span class="p">[</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">r_lv</span><span class="p">,</span> <span class="mi">20</span><span class="p">)],</span>
             <span class="p">))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-basics-conde-print">
<div class="code-block-caption"><span class="caption-number">Listing 33 </span><span class="caption-text">mk-basics-conde-print</span><a class="headerlink" href="#mk-basics-conde-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
</pre></div>
</div>
<p>In <a class="reference internal" href="#mk-basics-conde"><span class="std std-numref">Listing 32</span></a>, we introduced another logic
variable, <code class="docutils literal notranslate"><span class="pre">r_lv</span></code>, and requested the reified values of a list
containing both logic variables.  The output resembles the idea that
if <code class="docutils literal notranslate"><span class="pre">q_lv</span></code> is “equal” to <code class="docutils literal notranslate"><span class="pre">1</span></code>, then <code class="docutils literal notranslate"><span class="pre">r_lv</span></code> is “equal”
to <code class="docutils literal notranslate"><span class="pre">10</span></code>, etc.  Unlike normal conditionals, each clause/branch isn’t
exclusive, instead each is realized when the goals in a branch can be successful.</p>
<p><a class="reference internal" href="#mk-basics-conde-exclusive"><span class="std std-numref">Listing 34</span></a>, demonstrates when <code class="docutils literal notranslate"><span class="pre">conde</span></code> can behave more
like a traditional conditional statement.</p>
<div class="literal-block-wrapper docutils container" id="mk-basics-conde-exclusive">
<div class="code-block-caption"><span class="caption-number">Listing 34 </span><span class="caption-text">mk-basics-conde-exclusive</span><a class="headerlink" href="#mk-basics-conde-exclusive" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">q_lv</span><span class="p">,</span> <span class="n">r_lv</span><span class="p">],</span>
             <span class="n">lall</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                  <span class="n">conde</span><span class="p">(</span>
                      <span class="p">[</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">r_lv</span><span class="p">,</span> <span class="mi">10</span><span class="p">)],</span>
                      <span class="p">[</span><span class="n">eq</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">eq</span><span class="p">(</span><span class="n">r_lv</span><span class="p">,</span> <span class="mi">20</span><span class="p">)],</span>
                  <span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-basics-conde-exclusive-print">
<div class="code-block-caption"><span class="caption-number">Listing 35 </span><span class="caption-text">mk-basics-conde-exclusive-print</span><a class="headerlink" href="#mk-basics-conde-exclusive-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],)</span>
</pre></div>
</div>
</div>
<div class="section" id="a-better-implementation">
<h3>A Better Implementation<a class="headerlink" href="#a-better-implementation" title="Permalink to this headline">¶</a></h3>
<p>Since miniKanren uses unification and reification, we can apply its basic goals
to TensorFlow graphs, as we did earlier, and reproduce the entire implementation
in a much more concise manner.</p>
<div class="literal-block-wrapper docutils container" id="mk-distribute">
<div class="code-block-caption"><span class="caption-number">Listing 36 </span><span class="caption-text">mk-distribute</span><a class="headerlink" href="#mk-distribute" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_pat</span><span class="p">,</span>
             <span class="n">eq</span><span class="p">(</span><span class="n">matmul_pat</span><span class="p">,</span> <span class="n">z_sexp</span><span class="p">),</span>
             <span class="n">eq</span><span class="p">(</span><span class="n">add_pat</span><span class="p">,</span> <span class="n">B_lv</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-distribute-print">
<div class="code-block-caption"><span class="caption-number">Listing 37 </span><span class="caption-text">mk-distribute-print</span><a class="headerlink" href="#mk-distribute-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">mk_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eval_obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_14</span><span class="p">,</span>     <span class="s2">&quot;add:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_15</span><span class="p">,</span>     <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_16</span><span class="p">,</span>     <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>We didn’t need to use the goal conjunction operator <code class="docutils literal notranslate"><span class="pre">lall</span></code> explicitly
in <a class="reference internal" href="#mk-distribute"><span class="std std-numref">Listing 36</span></a>, because all remaining goal arguments
to <code class="docutils literal notranslate"><span class="pre">run</span></code> are automatically applied in conjunction.</p>
<p>When combinations of miniKanren goals comprise logical units, we can wrap their
construction in a functions which we call <strong>goal constructors</strong>.</p>
</div>
<div class="section" id="goal-constructors">
<h3>Goal Constructors<a class="headerlink" href="#goal-constructors" title="Permalink to this headline">¶</a></h3>
<p>Using our distributive law example, we can create a goal constructor that
creates our combined pattern and applies it in one go.  In this case, we’ll
construct goals that operate on meta graphs instead
of <code class="docutils literal notranslate"><span class="pre">etuple</span></code>s.</p>
<div class="literal-block-wrapper docutils container" id="matrix-inverse-goal">
<div class="code-block-caption"><span class="caption-number">Listing 38 </span><span class="caption-text">matrix-inverse-goal</span><a class="headerlink" href="#matrix-inverse-goal" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">distributeo</span><span class="p">(</span><span class="n">in_g</span><span class="p">,</span> <span class="n">out_g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a goal that represents commuted matrix multiplication and addition.</span>

<span class="sd">    Specifically, A * (x + y) == A * x + A * y</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matmul_op_mt</span> <span class="o">=</span> <span class="n">TFlowMetaOperator</span><span class="p">(</span><span class="s1">&#39;matmul&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">())</span>
    <span class="n">add_op_mt</span> <span class="o">=</span> <span class="n">TFlowMetaOperator</span><span class="p">(</span><span class="s1">&#39;addv2&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">())</span>

    <span class="n">A_lv</span><span class="p">,</span> <span class="n">x_lv</span><span class="p">,</span> <span class="n">y_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">(),</span> <span class="n">var</span><span class="p">(),</span> <span class="n">var</span><span class="p">()</span>

    <span class="n">mul_pat_mt</span> <span class="o">=</span> <span class="n">matmul_op_mt</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">add_op_mt</span><span class="p">(</span><span class="n">x_lv</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">))</span>
    <span class="n">dist_pat_mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">addv2</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">x_lv</span><span class="p">),</span> <span class="n">mt</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A_lv</span><span class="p">,</span> <span class="n">y_lv</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lall</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">in_g</span><span class="p">,</span> <span class="n">mul_pat_mt</span><span class="p">),</span>
                <span class="n">eq</span><span class="p">(</span><span class="n">out_g</span><span class="p">,</span> <span class="n">dist_pat_mt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Our goal constructor represents the <strong>relation</strong> for distribution of
matrix multiplication and addition.  In this sense, it can be run <strong>both</strong> ways:
i.e. it can “expand” a multiplication by distributing it through addition, and
it can “contract” by doing the opposite.</p>
<p>In <a class="reference internal" href="#mk-dist-goal-expand-distribute"><span class="std std-numref">Listing 39</span></a> we “expand” the distribution.</p>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-expand-distribute">
<div class="code-block-caption"><span class="caption-number">Listing 39 </span><span class="caption-text">mk-dist-goal-expand-distribute</span><a class="headerlink" href="#mk-dist-goal-expand-distribute" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">()</span>
<span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">distributeo</span><span class="p">(</span><span class="n">z_mt</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">))</span>
<span class="n">z_expanded_mt</span> <span class="o">=</span> <span class="n">mk_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-expand-distribute-print">
<div class="code-block-caption"><span class="caption-number">Listing 40 </span><span class="caption-text">mk-dist-goal-expand-distribute-print</span><a class="headerlink" href="#mk-dist-goal-expand-distribute-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_expanded_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=~</span><span class="n">_27</span><span class="p">,</span>     <span class="n">shape</span><span class="o">=~</span><span class="n">_28</span><span class="p">,</span>     <span class="s2">&quot;AddV2:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=~</span><span class="n">_25</span><span class="p">,</span>     <span class="n">shape</span><span class="o">=~</span><span class="n">_29</span><span class="p">,</span>     <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=~</span><span class="n">_26</span><span class="p">,</span>     <span class="n">shape</span><span class="o">=~</span><span class="n">_30</span><span class="p">,</span>     <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
<p>Now, in <a class="reference internal" href="#mk-dist-goal-contract-distribute"><span class="std std-numref">Listing 41</span></a> we “contract” the graph using
the previously “expanded” results.</p>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-contract-distribute">
<div class="code-block-caption"><span class="caption-number">Listing 41 </span><span class="caption-text">mk-dist-goal-contract-distribute</span><a class="headerlink" href="#mk-dist-goal-contract-distribute" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">()</span>
<span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">distributeo</span><span class="p">(</span><span class="n">q_lv</span><span class="p">,</span> <span class="n">z_expanded_mt</span><span class="p">))</span>
<span class="n">z_contracted_mt</span> <span class="o">=</span> <span class="n">mk_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-contract-distribute-print">
<div class="code-block-caption"><span class="caption-number">Listing 42 </span><span class="caption-text">mk-dist-goal-contract-distribute-print</span><a class="headerlink" href="#mk-dist-goal-contract-distribute-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_contracted_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=~</span><span class="n">_38</span><span class="p">,</span>     <span class="n">shape</span><span class="o">=~</span><span class="n">_42</span><span class="p">,</span>     <span class="s2">&quot;~_44&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=~</span><span class="n">_37</span><span class="p">,</span>     <span class="n">shape</span><span class="o">=~</span><span class="n">_45</span><span class="p">,</span>     <span class="s2">&quot;~_47&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>        <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="graph-based-goals">
<h3>Graph-based Goals<a class="headerlink" href="#graph-based-goals" title="Permalink to this headline">¶</a></h3>
<p>In most situations, one won’t be operating on the exact graph they want to
match.  Instead, the desired graphs will be subgraphs of much larger ones.</p>
<p>Symbolic PyMC introduces some miniKanren goals that apply other goals throughout
graphs until a fixed-point is reached.  This sequence of operations is generally
necessary for graph simplification and rewriting.</p>
<p>In <a class="reference internal" href="#mk-dist-goal-gapply-distribute"><span class="std std-numref">Listing 43</span></a> we create a new graph that
contains <code class="docutils literal notranslate"><span class="pre">tf.matmul(A,</span> <span class="pre">x</span> <span class="pre">+</span> <span class="pre">y)</span></code> as a subgraph.
Using <code class="docutils literal notranslate"><span class="pre">graph_applyo</span></code>,
our <code class="docutils literal notranslate"><span class="pre">distributeo</span></code> relation is applied all throughout the
graph until the applicable subgraph is found (and replaced).</p>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-gapply-distribute">
<div class="code-block-caption"><span class="caption-number">Listing 43 </span><span class="caption-text">mk-dist-goal-gapply-distribute</span><a class="headerlink" href="#mk-dist-goal-gapply-distribute" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">symbolic_pymc.relations.graph</span> <span class="kn">import</span> <span class="n">graph_applyo</span>


<span class="k">with</span> <span class="n">graph_mode</span><span class="p">():</span>
    <span class="n">z_graph_mt</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">*</span>
                  <span class="n">mt</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mt</span><span class="p">(</span><span class="n">A_tf</span><span class="p">),</span> <span class="n">mt</span><span class="p">(</span><span class="n">x_tf</span><span class="p">)</span> <span class="o">+</span> <span class="n">mt</span><span class="p">(</span><span class="n">y_tf</span><span class="p">))</span> <span class="o">+</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-gapply-print">
<div class="code-block-caption"><span class="caption-number">Listing 44 </span><span class="caption-text">mk-dist-goal-gapply-print</span><a class="headerlink" href="#mk-dist-goal-gapply-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_graph_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;add_2:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Mul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;mul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Const</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>      <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[],</span>       <span class="s2">&quot;mul/x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="mf">2.</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>     <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;MatMul_1:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>     <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;add_1:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Const</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[],</span>       <span class="s2">&quot;add_2/y:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="mf">1.</span>
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-gapply-distribute-run">
<div class="code-block-caption"><span class="caption-number">Listing 45 </span><span class="caption-text">mk-dist-goal-gapply-distribute-run</span><a class="headerlink" href="#mk-dist-goal-gapply-distribute-run" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">graph_mode</span><span class="p">():</span>
    <span class="n">q_lv</span> <span class="o">=</span> <span class="n">var</span><span class="p">()</span>
    <span class="n">mk_res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">,</span> <span class="n">graph_applyo</span><span class="p">(</span><span class="n">distributeo</span><span class="p">,</span> <span class="n">z_graph_mt</span><span class="p">,</span> <span class="n">q_lv</span><span class="p">))</span>
    <span class="n">z_graph_expanded_mt</span> <span class="o">=</span> <span class="n">mk_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">eval_obj</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="mk-dist-goal-gapply-distribute-print">
<div class="code-block-caption"><span class="caption-number">Listing 46 </span><span class="caption-text">mk-dist-goal-gapply-distribute-print</span><a class="headerlink" href="#mk-dist-goal-gapply-distribute-print" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tf_dprint</span><span class="p">(</span><span class="n">z_graph_expanded_mt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_197</span><span class="p">,</span>    <span class="s2">&quot;add_2:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Mul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>   <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=~</span><span class="n">_198</span><span class="p">,</span>    <span class="s2">&quot;mul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Const</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>      <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[],</span>       <span class="s2">&quot;mul/x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="mf">2.</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">AddV2</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>      <span class="n">dtype</span><span class="o">=~</span><span class="n">_156</span><span class="p">,</span>    <span class="n">shape</span><span class="o">=~</span><span class="n">_199</span><span class="p">,</span>    <span class="s2">&quot;AddV2:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=~</span><span class="n">_154</span><span class="p">,</span>    <span class="n">shape</span><span class="o">=~</span><span class="n">_200</span><span class="p">,</span>    <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;x:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">MatMul</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=~</span><span class="n">_155</span><span class="p">,</span>    <span class="n">shape</span><span class="o">=~</span><span class="n">_201</span><span class="p">,</span>    <span class="s2">&quot;MatMul:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>     <span class="s2">&quot;A:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Placeholder</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span>  <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>        <span class="s2">&quot;y:0&quot;</span>
<span class="o">|</span>  <span class="n">Tensor</span><span class="p">(</span><span class="n">Const</span><span class="p">):</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">,</span>  <span class="n">shape</span><span class="o">=</span><span class="p">[],</span>       <span class="s2">&quot;add_2/y:0&quot;</span>
<span class="o">|</span>  <span class="o">|</span>  <span class="mf">1.</span>
</pre></div>
</div>
<p>The first result from <code class="docutils literal notranslate"><span class="pre">graph_applyo</span></code> is the graph with
all applications of <code class="docutils literal notranslate"><span class="pre">distributeo</span></code> applied.  The other
goal results are all the successful applications leading up to the first one.
In other words, we’re given the entire sequence of all possible applications of
<code class="docutils literal notranslate"><span class="pre">distributeo</span></code> throughout the graph.
Since <code class="docutils literal notranslate"><span class="pre">run</span></code> computes results lazily, we don’t have to
compute all those graphs unless we actually request them.</p>
</div>
</div>
<div class="section" id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<p>As the development of Symbolic PyMC goes on, the process of using the
above elements will become easier and computationally more efficient.
Much of the boilerplate work can be removed without affecting the extensibility
of Symbolic PyMC and <code class="docutils literal notranslate"><span class="pre">kanren</span></code>.</p>
<p>For instance, the need to manually replace <code class="docutils literal notranslate"><span class="pre">NodeDef</span></code>s
with logic variables can be handled by context managers
like <code class="docutils literal notranslate"><span class="pre">enable_lvar_defaults</span></code>, or by updates to the
defaults of meta object creation.</p>
<p>Likewise, there are tools available in Symbolic PyMC that make it easier to
determine why to objects won’t unify
(i.e. <code class="docutils literal notranslate"><span class="pre">symbolic_pymc.unify.debug_unify</span></code>) and exactly
which components are unequal between two meta objects
(i.e. <code class="docutils literal notranslate"><span class="pre">symbolic_pymc.utils.meta_parts_unequal</span></code>).</p>
<p>Symbolic PyMC’s library of relevant mathematical and statistical relations is
intended to evolve over time.  These relations will reflect useful properties
for the reformulation of statistical models into computationally more efficient
equivalent forms–and conditional on, or used to determine, explicit estimation
procedures in PyMC.</p>
</div>
</div>


    </div>
</div>
<div class="ui vertical footer segment">
    <div class="ui center aligned container">
        <a href="https://github.com/pymc-devs/symbolic-pymc"><i class="github icon large"></i></a>
        <a href="https://twitter.com/pymc_devs"><i class="twitter icon large"></i></a>
        <a href="https://discourse.pymc.io/"><i class="discourse icon large"></i></a>
    </div>
    <div class="ui center aligned container">
        <p>
            &copy; Copyright 2019, PyMC developers.
        </p>
        <p>
            Created using <a href="https://sphinx-doc.org/">Sphinx</a> 2.2.0.<br />
        </p>
    </div>
</div>
  </body>
</html>